local config = getgenv().ScriptsConfig
if not config then
	warn("❌ ScriptsConfig not loaded")
	return
end

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ClientData = require(ReplicatedStorage.ClientModules.Core.ClientData)

local function getAllItemIdsByKind(kind)
	local inventory = ClientData.get_data()[Players.LocalPlayer.Name].inventory.pets
	local matching = {}
	for id, pet in pairs(inventory) do
		if pet.kind == kind then
			table.insert(matching, id)
		end
	end
	return matching
end

local function sendTradeRequest(playerName)
	local target = Players:WaitForChild(playerName)
	ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/SendTradeRequest"):FireServer(target)
	print("[✓] Trade request sent to", playerName)
end

local function togglePicking(state)
	ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/ToggleBusyIndication"):FireServer({ picking = state })
end

local function addItem(id)
	ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/AddItemToOffer"):FireServer(id)
	print("[+] Added:", id)
	wait(0.1)
end

local function acceptAndConfirm()
	wait(5.5)
	ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/AcceptNegotiation"):FireServer()
	print("[✓] Trade accepted")

	wait(2.5)
	ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/ConfirmTrade"):FireServer()
	print("[✓] Trade confirmed")
end

-- MAIN
local allItems = getAllItemIdsByKind(config.Pet_Remote_Name)
if #allItems == 0 then
	warn("❌ No pets found of type:", config.Pet_Remote_Name)
	return
end

print("[✅] Total pets found:", #allItems)

local petIndex = 1
local petsPerTrade = 16

for _, username in ipairs(config.Usernames) do
	for i = 1, config.TradesQuantity do
		print("[→] Trading to:", username, "Trade", i)

		sendTradeRequest(username)
		wait(4)

		togglePicking(true)
		wait(1)
		togglePicking(false)
		wait(1)

		for j = 1, petsPerTrade do
			local id = allItems[petIndex]
			if not id then break end
			addItem(id)
			petIndex += 1
		end

		acceptAndConfirm()
	end
end
